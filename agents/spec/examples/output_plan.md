# Implementation Plan: Invoice Processing Automation

**Source:** Requirements.md (Invoice Processing Automation)  
**Generated By:** Spec Agent v1.0  
**Date:** 2026-01-28  
**Status:** Ready for Implementation

---

## 1. Executive Summary

### Approach
This implementation uses a **modular architecture** with 8 atomic workflows coordinated by a main process workflow. The design prioritizes:
- API integrations over UI automation where possible
- Clear separation of concerns (Download → Extract → Validate → Upload)
- Comprehensive error handling with notifications
- Audit trail for compliance

### Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| Linear process (not REFramework) | Single daily batch run, not queue-based transactions |
| Document Understanding for extraction | Semi-structured PDFs require ML-based extraction |
| Sequential processing with error handling | Process 20-40 invoices with individual exception handling |
| Database logging | Audit trail + reporting requirements |

### Assumptions
- SAP API documentation will be provided before implementation
- QuickBooks OAuth tokens can be refreshed programmatically
- Network drive path is accessible from robot machine
- Document Understanding ML model is pre-trained for invoice extraction

---

## 2. Architecture

### Component Diagram

```
Main_InvoiceProcessing.xaml
├── LoginToPortal.xaml
├── DownloadInvoices.xaml
├── For Each Invoice:
│   ├── ExtractInvoiceData.xaml
│   ├── ValidateAgainstSAP.xaml
│   └── UploadToQuickBooks.xaml (if valid)
├── HandleExceptions.xaml (for invalid)
├── UpdateDatabase.xaml
└── SendNotifications.xaml
```

### Data Flow

```
Portal → PDF Files → Extracted Data → Validated Data → QuickBooks
                          ↓                  ↓
                     Database ←──────────────┘
                          ↓
                    Notifications
```

---

## 3. Workflow Specifications

### 3.1 Main_InvoiceProcessing.xaml

| Property | Value |
|----------|-------|
| **Purpose** | Orchestrate the complete invoice processing workflow |
| **Type** | Orchestrator |
| **Invoked By** | Orchestrator (scheduled trigger) |

#### Arguments

| Name | Direction | Type | Default | Description |
|------|-----------|------|---------|-------------|
| in_ConfigPath | In | String | "Config/Config.xlsx" | Path to configuration file |
| out_ProcessingStats | Out | Dictionary<String,Int32> | - | Statistics (processed, failed, skipped) |

#### Variables

| Name | Type | Scope | Description |
|------|------|-------|-------------|
| dic_Config | Dictionary<String,Object> | Main | Configuration settings |
| dt_Invoices | DataTable | Main | Downloaded invoice metadata |
| int_Processed | Int32 | Main | Count of successfully processed |
| int_Failed | Int32 | Main | Count of failed invoices |
| int_Skipped | Int32 | Main | Count of skipped (duplicates) |

#### Logic

```
1. Initialize
   - Read Config.xlsx
   - Initialize counters
   - Log start

2. Download Phase
   - Invoke LoginToPortal.xaml
   - Invoke DownloadInvoices.xaml → dt_Invoices

3. Processing Phase
   For Each row in dt_Invoices:
   - Invoke ExtractInvoiceData.xaml
   - If extraction succeeded:
     - Invoke ValidateAgainstSAP.xaml
     - If valid:
       - Invoke UploadToQuickBooks.xaml
       - Increment int_Processed
     - Else:
       - Invoke HandleExceptions.xaml
       - Increment int_Failed
   - Invoke UpdateDatabase.xaml

4. Notification Phase
   - Invoke SendNotifications.xaml (summary)

5. Finalize
   - Build out_ProcessingStats
   - Log completion
```

#### Error Handling
- Try-Catch around entire process
- Business exceptions: Log and continue to next invoice
- Application exceptions: Log, send alert, abort run

#### Autopilot Prompt

```
Create a workflow called Main_InvoiceProcessing.xaml using Modern Design.

Purpose: Orchestrate the complete invoice processing workflow

Arguments:
- in_ConfigPath (String, In): Path to configuration file, default "Config/Config.xlsx"
- out_ProcessingStats (Dictionary<String,Int32>, Out): Processing statistics

The workflow should:
1. Read configuration from Config.xlsx into a Dictionary
2. Initialize counter variables for processed, failed, and skipped invoices
3. Invoke LoginToPortal.xaml to authenticate with the vendor portal
4. Invoke DownloadInvoices.xaml to get invoice list as DataTable
5. For each row in the invoice DataTable:
   - Invoke ExtractInvoiceData.xaml with the PDF path
   - If extraction succeeded, invoke ValidateAgainstSAP.xaml
   - If validation passed, invoke UploadToQuickBooks.xaml and increment processed counter
   - If validation failed, invoke HandleExceptions.xaml and increment failed counter
   - Invoke UpdateDatabase.xaml for each invoice regardless of outcome
6. After all invoices, invoke SendNotifications.xaml with the summary
7. Build the output dictionary with final counts

Include Try-Catch error handling. Log at Info level for major steps.
Use Business Rule Exception for validation failures, Application Exception for system errors.
```

---

### 3.2 LoginToPortal.xaml

| Property | Value |
|----------|-------|
| **Purpose** | Authenticate with Acme Vendor Portal |
| **Type** | Atomic |
| **Invoked By** | Main_InvoiceProcessing.xaml |

#### Arguments

| Name | Direction | Type | Default | Description |
|------|-----------|------|---------|-------------|
| in_Config | In | Dictionary<String,Object> | - | Configuration with portal URL |
| in_Credential | In | SecureCredential | - | Portal credentials from Orchestrator |
| out_Success | Out | Boolean | - | Login success indicator |

#### Variables

| Name | Type | Scope | Description |
|------|------|-------|-------------|
| str_PortalURL | String | Main | Portal URL from config |
| int_RetryCount | Int32 | Main | Current retry attempt |

#### Activities
- Get Credential (Orchestrator)
- Use Application/Browser (Modern)
- Type Into (username)
- Type Into (password)
- Click (login button)
- Element Exists (success indicator)

#### Logic
```
1. Get credentials from Orchestrator asset
2. Open browser to portal URL
3. Enter username and password
4. Click login button
5. Verify successful login by checking for dashboard element
6. Return success status
```

#### Error Handling
- Retry Scope: 3 attempts with 5-second delay
- Selector not found: Throw Application Exception
- Invalid credentials: Throw Business Rule Exception

#### Autopilot Prompt

```
Create a workflow called LoginToPortal.xaml using Modern Design.

Purpose: Authenticate with Acme Vendor Portal

Arguments:
- in_Config (Dictionary<String,Object>, In): Configuration with portal URL
- in_Credential (SecureCredential, In): Portal credentials from Orchestrator
- out_Success (Boolean, Out): Login success indicator

The workflow should:
1. Extract portal URL from in_Config dictionary
2. Open Chrome browser using Use Application/Browser activity
3. Type username into the username field
4. Type password (as SecureString) into the password field
5. Click the login button
6. Wait for and verify the dashboard element appears
7. Set out_Success to True if dashboard found, False otherwise

Include Retry Scope with 3 attempts and 5-second delay around the login sequence.
If login fails after all retries, throw Application Exception.
Log at Info level: "Logging into portal", "Login successful/failed".
```

---

### 3.3 ExtractInvoiceData.xaml

| Property | Value |
|----------|-------|
| **Purpose** | Extract key fields from invoice PDF using Document Understanding |
| **Type** | Atomic |
| **Invoked By** | Main_InvoiceProcessing.xaml |

#### Arguments

| Name | Direction | Type | Default | Description |
|------|-----------|------|---------|-------------|
| in_PDFPath | In | String | - | Path to invoice PDF file |
| in_Config | In | Dictionary<String,Object> | - | Configuration settings |
| out_InvoiceData | Out | DataRow | - | Extracted invoice data |
| out_Confidence | Out | Double | - | Extraction confidence score |
| out_Success | Out | Boolean | - | Extraction success indicator |

#### Variables

| Name | Type | Scope | Description |
|------|------|-------|-------------|
| doc_Invoice | Document | Main | Loaded document object |
| str_InvoiceNumber | String | Main | Extracted invoice number |
| str_VendorName | String | Main | Extracted vendor name |
| date_InvoiceDate | DateTime | Main | Extracted invoice date |
| dec_TotalAmount | Decimal | Main | Extracted total amount |

#### Activities
- Load Document
- Digitize Document
- Data Extraction Scope
- Create DataRow

#### Logic
```
1. Load PDF document
2. Digitize document for text extraction
3. Use Data Extraction Scope with Invoice ML model
4. Extract fields: InvoiceNumber, VendorName, InvoiceDate, TotalAmount
5. Calculate average confidence score
6. If confidence >= 85%, build DataRow with extracted data
7. If confidence < 85%, set out_Success = False
8. Return results
```

#### Error Handling
- Extraction failure: Return Success = False with empty DataRow
- Corrupt PDF: Log error, return Success = False

#### Autopilot Prompt

```
Create a workflow called ExtractInvoiceData.xaml using Modern Design.

Purpose: Extract key fields from invoice PDF using Document Understanding

Arguments:
- in_PDFPath (String, In): Path to invoice PDF file
- in_Config (Dictionary<String,Object>, In): Configuration settings
- out_InvoiceData (DataRow, Out): Extracted invoice data
- out_Confidence (Double, Out): Extraction confidence score
- out_Success (Boolean, Out): Extraction success indicator

The workflow should:
1. Use Load Document activity to load the PDF
2. Use Digitize Document to prepare for extraction
3. Use Data Extraction Scope with the Invoice ML model
4. Extract these fields: InvoiceNumber, VendorName, InvoiceDate, TotalAmount
5. Calculate the average confidence score across all fields
6. If average confidence >= 0.85:
   - Create a DataRow with the extracted values
   - Set out_Success = True
7. If confidence < 0.85:
   - Set out_Success = False
   - Log warning about low confidence

Include Try-Catch. On exception, set out_Success = False and log the error with PDF path.
Log at Info level: "Extracting data from [filename]", "Extraction complete, confidence: X%".
```

---

### 3.4 ValidateAgainstSAP.xaml

| Property | Value |
|----------|-------|
| **Purpose** | Validate invoice against SAP purchase order |
| **Type** | Atomic |
| **Invoked By** | Main_InvoiceProcessing.xaml |

#### Arguments

| Name | Direction | Type | Default | Description |
|------|-----------|------|---------|-------------|
| in_InvoiceData | In | DataRow | - | Extracted invoice data |
| in_Config | In | Dictionary<String,Object> | - | Configuration with SAP API details |
| out_IsValid | Out | Boolean | - | Validation result |
| out_ValidationMessage | Out | String | - | Validation details or error |

#### Variables

| Name | Type | Scope | Description |
|------|------|-------|-------------|
| str_SAPURL | String | Main | SAP API endpoint |
| jobj_Response | JObject | Main | API response |
| dec_POAmount | Decimal | Main | PO amount from SAP |

#### Activities
- HTTP Request
- Deserialize JSON
- If (validation checks)

#### Logic
```
1. Build SAP API request with PO number from invoice
2. Call SAP API to retrieve PO details
3. Validate:
   - PO exists and is "Open" status
   - Vendor ID matches
   - Invoice amount within ±5% of PO amount
4. Return validation result and message
```

#### Error Handling
- API timeout: Retry once, then mark as "Validation Unavailable"
- API error: Log error, return IsValid = False

#### Autopilot Prompt

```
Create a workflow called ValidateAgainstSAP.xaml using Modern Design.

Purpose: Validate invoice against SAP purchase order via API

Arguments:
- in_InvoiceData (DataRow, In): Extracted invoice data with PO number
- in_Config (Dictionary<String,Object>, In): Configuration with SAP API details
- out_IsValid (Boolean, Out): Validation result
- out_ValidationMessage (String, Out): Validation details or error message

The workflow should:
1. Extract SAP API URL and credentials from config
2. Extract PO number from in_InvoiceData
3. Build HTTP Request to SAP API: GET /api/purchaseorders/{PONumber}
4. Execute request with 30-second timeout
5. Deserialize JSON response
6. Validate:
   - PO exists (response not empty)
   - PO status = "Open"
   - Vendor ID matches invoice vendor
   - Invoice amount is within ±5% of PO amount
7. Set out_IsValid based on all checks passing
8. Build out_ValidationMessage with validation details

Include retry logic: on timeout or 5xx error, wait 10 seconds and retry once.
On validation failure, include specific reason in out_ValidationMessage.
Log at Info level: "Validating invoice X against PO Y", "Validation result: Pass/Fail - reason".
```

---

### 3.5 UploadToQuickBooks.xaml

| Property | Value |
|----------|-------|
| **Purpose** | Upload validated invoice to QuickBooks |
| **Type** | Atomic |
| **Invoked By** | Main_InvoiceProcessing.xaml |

#### Arguments

| Name | Direction | Type | Default | Description |
|------|-----------|------|---------|-------------|
| in_InvoiceData | In | DataRow | - | Validated invoice data |
| in_PDFPath | In | String | - | Path to original PDF |
| in_Config | In | Dictionary<String,Object> | - | Configuration with QB API details |
| out_Success | Out | Boolean | - | Upload success indicator |
| out_QuickBooksID | Out | String | - | Created bill ID in QuickBooks |

#### Variables

| Name | Type | Scope | Description |
|------|------|-------|-------------|
| str_AccessToken | String | Main | OAuth access token |
| jobj_BillRequest | JObject | Main | Bill creation request body |
| jobj_Response | JObject | Main | API response |

#### Activities
- HTTP Request (OAuth token refresh)
- Build JSON (Bill object)
- HTTP Request (Create Bill)
- HTTP Request (Upload attachment)

#### Logic
```
1. Check/refresh OAuth access token
2. Build QuickBooks Bill JSON object from invoice data
3. POST to QuickBooks Bill endpoint
4. Upload PDF as attachment to created bill
5. Return success and QuickBooks ID
```

#### Error Handling
- 401 Unauthorized: Refresh token and retry
- Rate limit (429): Wait 60 seconds and retry
- Other errors: Retry once, then return failure

#### Autopilot Prompt

```
Create a workflow called UploadToQuickBooks.xaml using Modern Design.

Purpose: Upload validated invoice to QuickBooks via API

Arguments:
- in_InvoiceData (DataRow, In): Validated invoice data
- in_PDFPath (String, In): Path to original PDF for attachment
- in_Config (Dictionary<String,Object>, In): Configuration with QuickBooks API details
- out_Success (Boolean, Out): Upload success indicator
- out_QuickBooksID (String, Out): Created bill ID in QuickBooks

The workflow should:
1. Get OAuth access token from Orchestrator asset
2. Build QuickBooks Bill JSON object with:
   - VendorRef from invoice vendor
   - TxnDate from invoice date
   - Line items with amount
   - PrivateNote: "Auto-processed from Acme Portal"
3. POST to QuickBooks API: /v3/company/{companyId}/bill
4. Parse response to get created Bill ID
5. Upload PDF attachment using /v3/company/{companyId}/upload endpoint
6. Set out_Success and out_QuickBooksID

Handle 401 errors by refreshing OAuth token and retrying.
Handle 429 rate limit by waiting 60 seconds and retrying.
Log at Info level: "Uploading invoice X to QuickBooks", "Created QuickBooks bill: ID".
```

---

## 4. Data Structures

### Invoice DataTable Schema

| Column | Type | Description |
|--------|------|-------------|
| InvoiceNumber | String | Unique invoice identifier |
| VendorName | String | Vendor name |
| VendorID | String | Vendor identifier |
| InvoiceDate | DateTime | Invoice date |
| TotalAmount | Decimal | Invoice total |
| PONumber | String | Purchase order reference |
| PDFPath | String | Path to downloaded PDF |
| Status | String | Processing status |
| ErrorMessage | String | Error details if failed |
| QuickBooksID | String | ID after QB upload |

### Config.xlsx Structure

**Settings Sheet:**
| Name | Value | Description |
|------|-------|-------------|
| PortalURL | https://portal.acme-vendor.com | Vendor portal URL |
| NetworkDrivePath | \\\\server\\invoices | PDF storage location |
| MaxRetryCount | 3 | Retry attempts |

**Assets Sheet:**
| Name | Type | Description |
|------|------|-------------|
| AcmePortal_Credential | Credential | Portal login |
| SAP_APIKey | Credential | SAP API authentication |
| QuickBooks_OAuth | Credential | QB OAuth tokens |

---

## 5. Test Strategy Reference

### Coverage Summary

| Test Type | Count | Coverage |
|-----------|-------|----------|
| Unit Tests | 14 | Each atomic workflow |
| Integration Tests | 5 | Workflow combinations |
| E2E Tests | 3 | Full process scenarios |
| Negative Tests | 8 | Error scenarios |

---

**Document Version:** 1.0  
**Generated By:** Spec Agent v1.0  
**Generation Date:** 2026-01-28
